<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web Scraper</title>
    <style>
        #emergency-debug-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            padding: 10px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        #debug-output {
            position: fixed;
            top: 50px;
            right: 20px;
            z-index: 9999;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            max-width: 80%;
            max-height: 80%;
            overflow: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <button id="emergency-debug-button">EMERGENCY DEBUG</button>
    <div id="debug-output"></div>

    <!-- Add initialization tracking -->
    <script>
        console.log('üöÄ Page initialization started');
        window.reactInitialized = false;

        // Track when React mounts
        window.markReactMounted = function() {
            window.reactInitialized = true;
            console.log('‚úÖ React application mounted successfully');
        };

        // Check if React initialized after a timeout
        setTimeout(function() {
            if (!window.reactInitialized) {
                console.error('‚ùå React application failed to initialize within 3 seconds');

                // Try to reload the bundle
                const script = document.createElement('script');
                script.src = '/js/dist/main.bundle.js?t=' + new Date().getTime();
                script.onload = function() {
                    console.log('üîÑ Bundle reloaded');
                };
                document.body.appendChild(script);
            }
        }, 3000);
    </script>

    <script src="/js/dist/main.bundle.js"></script>
    <script src="/js/debug.js"></script>

    <script>
        // Inline emergency debug script
        document.getElementById('emergency-debug-button').addEventListener('click', function() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<h3>Running emergency debug...</h3>';

            // Get current URL path
            const path = window.location.pathname;
            let id = '';

            if (path.includes('/configure/')) {
                id = path.split('/configure/')[1];
                debugOutput.innerHTML += `<p>On configuration page with ID: ${id}</p>`;
            } else {
                debugOutput.innerHTML += `<p>Current path: ${path}</p>`;
            }

            // Make API call to get all scrapers
            fetch('/api/scraper', {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                debugOutput.innerHTML += `<p>All scrapers API status: ${response.status}</p>`;
                return response.text();
            })
            .then(text => {
                debugOutput.innerHTML += `<p>All scrapers response length: ${text.length} characters</p>`;

                try {
                    const scrapers = JSON.parse(text);
                    debugOutput.innerHTML += `<p>Found ${scrapers.length} scrapers</p>`;

                    // Display all scrapers
                    debugOutput.innerHTML += '<h4>All Scrapers:</h4>';
                    debugOutput.innerHTML += '<ul>';
                    scrapers.forEach(s => {
                        debugOutput.innerHTML += `<li>ID: ${s.id || s.Id}, Name: ${s.name || s.Name}</li>`;
                    });
                    debugOutput.innerHTML += '</ul>';

                    // If on configure page, find matching scraper
                    if (id) {
                        const matchingScraper = scrapers.find(s =>
                            s.id === id ||
                            s.Id === id ||
                            s.name === id ||
                            s.Name === id
                        );

                        if (matchingScraper) {
                            debugOutput.innerHTML += `<p>Found matching scraper: ${matchingScraper.name || matchingScraper.Name}</p>`;

                            // Get actual ID
                            const actualId = matchingScraper.id || matchingScraper.Id;
                            debugOutput.innerHTML += `<p>Actual scraper ID: ${actualId}</p>`;

                            // Fetch specific scraper
                            fetch(`/api/scraper/${actualId}`, {
                                headers: {
                                    'Accept': 'application/json'
                                }
                            })
                            .then(response => {
                                debugOutput.innerHTML += `<p>Specific scraper API status: ${response.status}</p>`;
                                return response.text();
                            })
                            .then(text => {
                                debugOutput.innerHTML += `<p>Specific scraper response length: ${text.length} characters</p>`;

                                try {
                                    const data = JSON.parse(text);
                                    debugOutput.innerHTML += '<h4>Scraper Details:</h4>';
                                    debugOutput.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                                    // Add a button to populate the form
                                    debugOutput.innerHTML += '<button id="populate-form">Populate Form</button>';

                                    setTimeout(() => {
                                        document.getElementById('populate-form').addEventListener('click', function() {
                                            // Try to find form fields and populate them
                                            const fields = document.querySelectorAll('input, textarea, select');
                                            debugOutput.innerHTML += `<p>Found ${fields.length} form fields</p>`;

                                            fields.forEach(field => {
                                                const name = field.name;
                                                if (name && (data[name] !== undefined || data[name.charAt(0).toUpperCase() + name.slice(1)] !== undefined)) {
                                                    const value = data[name] !== undefined ? data[name] : data[name.charAt(0).toUpperCase() + name.slice(1)];

                                                    if (field.type === 'checkbox') {
                                                        field.checked = Boolean(value);
                                                    } else {
                                                        field.value = value;
                                                    }

                                                    debugOutput.innerHTML += `<p>Set field ${name} to ${value}</p>`;

                                                    // Trigger change event
                                                    const event = new Event('change', { bubbles: true });
                                                    field.dispatchEvent(event);
                                                }
                                            });
                                        });
                                    }, 100);
                                } catch (e) {
                                    debugOutput.innerHTML += `<p>Error parsing specific scraper response: ${e.message}</p>`;
                                    debugOutput.innerHTML += `<pre>${text}</pre>`;
                                }
                            })
                            .catch(error => {
                                debugOutput.innerHTML += `<p>Error fetching specific scraper: ${error.message}</p>`;
                            });
                        } else {
                            debugOutput.innerHTML += `<p>No matching scraper found for ID: ${id}</p>`;
                        }
                    }
                } catch (e) {
                    debugOutput.innerHTML += `<p>Error parsing all scrapers response: ${e.message}</p>`;
                    debugOutput.innerHTML += `<pre>${text}</pre>`;
                }
            })
            .catch(error => {
                debugOutput.innerHTML += `<p>Error fetching all scrapers: ${error.message}</p>`;
            });

            // Add close button
            debugOutput.innerHTML += '<button id="close-debug" style="margin-top: 10px;">Close</button>';

            setTimeout(() => {
                document.getElementById('close-debug').addEventListener('click', function() {
                    debugOutput.style.display = 'none';
                });
            }, 100);
        });
    </script>
</body>
</html>